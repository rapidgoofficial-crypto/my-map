<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNOWLEDGE HUB - Location Picker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ‡∑É‡∂ª‡∑ä‡∂†‡∑ä ‡∂∂‡∑è‡∂ª‡∑ä ‡∑É‡∑Ñ ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏‡∑ä ‡∂á‡∂≠‡∑í ‡∂ö‡∑ú‡∂ß‡∑É */
        #controls {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 90%;
            max-width: 400px;
        }
        
        .search-row { display: flex; gap: 5px; }

        #search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            outline: none;
        }
        
        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }

        #search-btn { background: #25d366; } /* WhatsApp Green */
        #location-btn { background: #007bff; width: 100%; } /* Blue */
    </style>
</head>
<body>

    <div id="controls">
        <div class="search-row">
            <input type="text" id="search-input" placeholder="‡∂Ω‡∑í‡∂¥‡∑í‡∂±‡∂∫ ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±...">
            <button class="btn" id="search-btn" onclick="searchLocation()">‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±</button>
        </div>
        <button class="btn" id="location-btn" onclick="getCurrentLocation()">üìç ‡∂∏‡∂ú‡∑ö ‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∑É‡∑ä‡∂Æ‡∑è‡∂±‡∂∫ ‡∂Ω‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        var map = L.map('map').setView([6.9271, 79.8612], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        var marker = L.marker([6.9271, 79.8612], { draggable: true }).addTo(map);

        function sendLocationToBot(lat, lng) {
            var googleMapsLink = "https://www.google.com/maps?q=" + lat + "," + lng;
            if (window.parent) {
                window.parent.postMessage({
                    type: 'setVariable',
                    name: 'LocationLink',
                    value: googleMapsLink
                }, '*');
            }
        }

        marker.on('dragend', function (event) {
            var position = marker.getLatLng();
            sendLocationToBot(position.lat, position.lng);
        });

        // ‡∑É‡∂ª‡∑ä‡∂†‡∑ä ‡∂ö‡∂ª‡∂± ‡∂ö‡∑ú‡∂ß‡∑É
        function searchLocation() {
            var query = document.getElementById('search-input').value;
            if (!query) return;
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + query)
                .then(res => res.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = data[0].lat, lon = data[0].lon;
                        map.setView([lat, lon], 16);
                        marker.setLatLng([lat, lon]);
                        sendLocationToBot(lat, lon);
                    }
                });
        }

        // --- ‡∂∏‡∑ô‡∂±‡∑ä‡∂± ‡∂Ö‡∂Ω‡∑î‡∂≠‡∑í‡∂±‡∑ä ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∑Ö ‡∑Ä‡∂≠‡∑ä‡∂∏‡∂±‡∑ä ‡∑É‡∑ä‡∂Æ‡∑è‡∂±‡∂∫ ‡∂Ω‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±‡∑è ‡∂ö‡∑ú‡∂ß‡∑É ---
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert("‡∂î‡∂∂‡∑ö ‡∂∂‡∑ä‚Äç‡∂ª‡∑Ä‡∑î‡∑É‡∂ª‡∂∫ ‡∂∏‡∑ô‡∂∫‡∂ß ‡∑É‡∑Ñ‡∂∫ ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂±‡∑ä‡∂±‡∑ö ‡∂±‡∑ê‡∂≠.");
                return;
            }
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                map.setView([lat, lng], 17);
                marker.setLatLng([lat, lng]);
                sendLocationToBot(lat, lng);
            }, function() {
                alert("‡∂Ω‡∑ú‡∂ö‡∑ö‡∑Ç‡∂±‡∑ä ‡∂ë‡∂ö ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑í‡∂∫. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª Permission ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.");
            }, { enableHighAccuracy: true });
        }
        // -------------------------------------------------------

        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            sendLocationToBot(e.latlng.lat, e.latlng.lng);
        });

        sendLocationToBot(6.9271, 79.8612);
    </script>
</body>
</html>
